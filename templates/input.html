<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ReLeaf | Stress Input</title>
  <style>
    body {
      margin: 0;
      padding: 30px;
      font-family: 'Segoe UI', sans-serif;
      background-color: #e6f9f9;
      display: flex;
      justify-content: center;
    }

    .form-container {
      background-color: #fff;
      padding: 40px;
      border-radius: 15px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.1);
      max-width: 800px;
      width: 100%;
    }

    h2, h3 {
      color: #006666;
    }

    input, select, button {
      width: 100%;
      padding: 12px;
      margin: 10px 0 20px;
      border: 1px solid #ccc;
      border-radius: 25px;
      outline: none;
      font-size: 15px;
    }

    button[type="submit"], button[type="button"] {
      background-color: #3cb5ad;
      color: white;
      border: none;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    button:hover {
      background-color: #2e8b8b;
    }

    #video, #imagePreview {
      border: 2px solid #555;
      margin-top: 10px;
      max-width: 320px;
      border-radius: 10px;
    }

    .section {
      margin-bottom: 35px;
    }

    #emotionResult, #typingResult {
      margin-top: -10px;
      margin-bottom: 20px;
      font-style: italic;
      color: #555;
    }
  </style>
</head>
<body>

  <div class="form-container">
    <h2>üß† ReLeaf Stress Predictor</h2>

    <form action="/predict" method="POST" enctype="multipart/form-data">

      <!-- Typing Test -->
      <div class="section">
        <h3>1Ô∏è‚É£ Typing Speed Test</h3>
        <p id="targetSentence">Click 'Start' to begin typing.</p>
        <input type="text" id="typingBox" placeholder="Type here..." disabled autocomplete="off">
        <button type="button" onclick="startTyping()">‚ñ∂Ô∏è Start Typing</button>
        <p id="typingResult"></p>
        <input type="hidden" name="typing_speed" id="typing_speed">
        <input type="hidden" name="typos" id="typos">
      </div>

      <!-- User Inputs -->
      <div class="section">
        <h3>2Ô∏è‚É£ Your Details</h3>
        <label>Sleep Hours:</label>
        <input type="number" name="sleep" step="0.1" required>

        <label>Screen Time (hours):</label>
        <input type="number" name="screen" step="0.1" required>

        <label>User Type:</label>
        <select name="user_type" required>
          <option value="student">Student</option>
          <option value="professional">Professional</option>
          <option value="gamer">Gamer</option>
          <option value="casual">Casual</option>
        </select>
      </div>

      <!-- Emotion Detection -->
      <div class="section">
        <h3>3Ô∏è‚É£ Facial Expression</h3>

        <button type="button" onclick="startCamera()">üé• Start Webcam</button>
        <button type="button" id="snapBtn" onclick="captureImage()" style="display: none;">üì∏ Capture</button><br>
        <video id="video" width="320" height="240" autoplay style="display: none;"></video>

        <p style="margin: 15px 0;">OR</p>
        <input type="file" accept="image/*" id="imageUpload" onchange="storeUploadedImage(this.files[0])">

        <input type="file" name="image" id="finalImageInput" style="display: none;" required>

        <h4 style="margin-top: 20px;">üñºÔ∏è Preview:</h4>
        <img id="imagePreview" src="#" alt="No image selected yet" style="display: none;">
        <p id="emotionResult">üß† No image selected yet.</p>
      </div>

      <button type="submit">üöÄ Submit</button>
    </form>
  </div>

  <script>
    let startTime;
    let videoStream = null;

    const targetSentences = [
      "The quick brown fox jumps over the lazy dog.",
      "Debugging is like being the detective in a crime movie.",
      "Simplicity is the soul of efficiency.",
      "A bug in the code is worth two in production.",
      "Great code is its own best documentation."
    ];

    function startTyping() {
      const selected = targetSentences[Math.floor(Math.random() * targetSentences.length)];
      document.getElementById("targetSentence").innerText = `"${selected}"`;

      const input = document.getElementById("typingBox");
      input.value = "";
      input.disabled = false;
      input.focus();
      startTime = new Date().getTime();

      input.onkeydown = function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          finishTyping(selected);
        }
      };
    }

    function finishTyping(selected) {
      const endTime = new Date().getTime();
      const typed = document.getElementById("typingBox").value;
      const timeTaken = (endTime - startTime) / 1000.0;

      const targetWords = selected.trim().split(" ");
      const typedWords = typed.trim().split(" ");
      let typos = 0;

      for (let i = 0; i < Math.min(targetWords.length, typedWords.length); i++) {
        if (targetWords[i] !== typedWords[i]) typos++;
      }
      typos += Math.abs(targetWords.length - typedWords.length);

      const correctWords = Math.max(targetWords.length - typos, 0);
      const wpm = (correctWords / timeTaken) * 60;

      document.getElementById("typingResult").innerText =
        `‚úÖ Typing Speed: ${wpm.toFixed(2)} WPM | ‚ùå Typos: ${typos}`;
      document.getElementById("typing_speed").value = wpm.toFixed(2);
      document.getElementById("typos").value = typos;
      document.getElementById("typingBox").disabled = true;
    }

    async function startCamera() {
      try {
        videoStream = await navigator.mediaDevices.getUserMedia({ video: true });
        const video = document.getElementById("video");
        video.srcObject = videoStream;
        video.style.display = "block";
        document.getElementById("snapBtn").style.display = "inline-block";
      } catch (err) {
        alert("‚ö†Ô∏è Could not access webcam.");
      }
    }

    function stopCamera() {
      if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
        videoStream = null;
      }
      document.getElementById("video").style.display = "none";
      document.getElementById("snapBtn").style.display = "none";
    }

    function captureImage() {
      const video = document.getElementById("video");
      const canvas = document.createElement("canvas");
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext("2d").drawImage(video, 0, 0);

      canvas.toBlob(function(blob) {
        replaceFileInputWithBlob(blob, "webcam.jpg");
        showImagePreview(blob);
        document.getElementById("emotionResult").innerText = "üß† Captured via webcam.";
      }, "image/jpeg");

      stopCamera();
    }

    function storeUploadedImage(file) {
      if (file) {
        replaceFileInputWithBlob(file, file.name);
        showImagePreview(file);
        document.getElementById("emotionResult").innerText = `üß† Uploaded: ${file.name}`;
      }
    }

    function replaceFileInputWithBlob(blob, filename) {
      const dt = new DataTransfer();
      const newFile = new File([blob], filename, { type: blob.type });
      dt.items.add(newFile);

      const finalInput = document.getElementById("finalImageInput");
      finalInput.files = dt.files;
    }

    function showImagePreview(blobOrFile) {
      const preview = document.getElementById("imagePreview");
      const reader = new FileReader();

      reader.onload = function (e) {
        preview.src = e.target.result;
        preview.style.display = "block";
      };

      reader.readAsDataURL(blobOrFile);
    }
  </script>

</body>
</html>
